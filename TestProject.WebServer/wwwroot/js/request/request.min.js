(function(){angular.module("pageList",[])})();angular.module("pageList").directive("pagelist",function(){return{restrict:"E",templateUrl:"/Home/PageList",scope:{filterOptions:"=filterOptions",getItemsCallback:"=getItemsCallback"},controller:function(n){n.goToPage=function(t){n.filterOptions.currentPage=t;n.getItemsCallback()};n.lastPages=function(){const t=[];for(let i=Math.max(4,n.filterOptions.totalPages-2);i<=n.filterOptions.totalPages;i++)t.push(i);return t}}}});angular.module("requestApp",["pageList","ui.bootstrap","720kb.datepicker","moment-picker","ngFileUpload"]).controller("requestCtrl",function(n,t,i,r){function u(n){this.name=n;this.requestTypeFields=[]}n.isLoading=!1;n.requests=[];n.currentUser={};n.requestTypes=[];n.onLoadCallbacks=[];n.requestStatuses=[];n.grid={id:"",requestType:"",dateCreated:"",creator:"",dateCreated:""};n.filterOptions={currentPage:1,pageSize:20,totalPages:null,options:null};n.getFilterOptions=function(){const t={filters:[],sortings:[]};for(let i in n.grid)if(n.grid[i]){const r={field:i,value:[]};r.value.push(n.grid[i]);t.filters.push(r)}if(n.filterMeta)for(let i in n.filterMeta){const r=n.filterMeta[i],u={field:i,value:[]};if(r.type==="filterById"){for(i in r.values)for(let n=0;n<r.values[i].length;n++)u.value.push(r.values[i][n]);t.filters.push(u)}}return t};n.getFilters=function(){n.filterOptions.options=n.getFilterOptions();n.filterOptions.currentPage=1};n.onPropertyChanged=function(){n.getFilters();n.getRequests()};n.onLoadCallbacks.push(n.getFilters);n.getCurrentUser=function(){t.get("/account/GetCurrentUser").then(t=>{t.data.success&&(n.currentUser=t.data.response)},n=>{n.data.errorMessage&&toast.error({bodyText:n.data.errorMessage})})};n.onLoadCallbacks.push(n.getCurrentUser);n.getSecondaryData=function(){n.isLoading=!0;t.get("/request/GetSecondaryData").then(t=>{t.data.success?(n.requestTypes=t.data.response.requestTypes,n.requestStatuses=t.data.response.requestStatuses,t.data.message&&toast.succes({bodyText:t.data.message})):toast.error({bodyText:t.data.errorMessage}),n.isLoading=!1}).catch(t=>{n.isLoading=!1,t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage})})};n.onLoadCallbacks.push(n.getSecondaryData);n.getRequests=function(){n.isLoading=!0;console.log(n.filterOptions);t.post("/request/getrequests",n.filterOptions).then(function(t){t.data.success&&(n.requests=t.data.response.requests,Object.assign(n.filterOptions,{totalPages:t.data.response.totalPages,hasPreviousPage:t.data.response.hasPreviousPage,hasNextPage:t.data.response.hasNextPage}));n.isLoading=!1}).catch(function(t){n.isLoading=!1;toast.error({bodyText:t.data.errorMessage})});console.log("requests done")};n.onLoadCallbacks.push(n.getRequests);n.selectRequest=function(t){n.request!==user&&(n.request&&(n.request.isSelected=!1),n.request=t,n.request.isSelected=!0,n.getRequest(t))};n.getRequest=function(i){n.isLoading=!0;t.post(`/request/GetRequest?id=${i.id}`).then(t=>{t.data.success?(n.selectedRequest&&n.selectedRequest!==i&&(n.selectedRequest.isSelected=!1),n.request=t.data.response,n.selectedRequest=i,n.selectedRequest.isSelected=!0):toast.error({bodyText:t.data.errorMessage}),n.isLoading=!1}).catch(t=>{n.isLoading=!1,toast.error({bodyText:t.data.errorMessage})})};n.createRequestTemplate=function(){n.selectedRequest&&(n.selectedRequest.isSelected=!1);n.request=new u("Новая заявка")};n.addRequest=function(){n.request.id||(n.isLoading=!0,t.post("/request/AddRequest",n.request).then(t=>{t.data.success?(Object.assign(n.request,t.data.response),t.data.message&&toast.succes({bodyText:t.data.message}),n.getRequests()):toast.error({bodyText:t.data.errorMessage}),n.isLoading=!1},t=>{n.isLoading=!1,t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage})}))};n.updateRequest=function(){n.isLoading=!0;t.post("/request/UpdateRequest",n.request).then(t=>{if(t.data.success){try{Object.assign(n.request,t.data.response,{isChanged:!1});Object.assign(n.selectedRequest,{displayStatus:n.request.displayStatus,type:n.request.requestType.name})}catch(i){n.getRequests()}t.data.message&&toast.succes({bodyText:t.data.message})}else toast.error({bodyText:t.data.errorMessage});n.isLoading=!1},t=>{n.isLoading=!1,t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage})})};n.getRequestFieldsData=function(){n.request.id&&(n.isLoading=!0,t.post(`/request/GetFieldsData?typeId=${n.request.requestType.id}&reqId=${n.request.id}`).then(t=>{t.data.success?n.request.requestType=t.data.response:t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage}),n.isLoading=!1}).catch(t=>{n.isLoading=!1,t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage})}))};n.uploadFile=function(n){n.isFileLoading=!0;r.upload({url:"/File/Upload",file:n.file}).then(t=>{t.data.success&&(n.requestValue.fileValue=t.data.response.fileGuid,n.requestValue.fileName=t.data.response.name),n.isFileLoading=!1,n.fileLoadProgress=0},t=>{n.isFileLoading=!1,t.data.errorMessage&&toast.error({bodyText:t.data.errorMessage})},t=>{n.fileLoadProgress=parseInt(100*t.loaded/t.total)})};n.closeRequest=function(){n.request=null;n.selectedRequest&&(n.selectedRequest.isSelected=!1,n.selectedRequest=null)};n.setFilterRequestType=function(t){t.isSelected=!t.isSelected;let i=n.filterMeta.requestType.values.requestTypeIds.indexOf(t.id);t.isSelected?i===-1&&n.filterMeta.requestType.values.requestTypeIds.push(t.id):i>-1&&n.filterMeta.requestType.values.requestTypeIds.splice(i,1);n.onPropertyChanged()};n.filterMeta={requestType:{type:"filterById",values:{requestTypeIds:[]}}};n.onLoadCallbacks.reduce((n,t)=>n.then(t),Promise.resolve("privet"))});